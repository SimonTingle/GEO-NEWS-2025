<!DOCTYPE html>
<head>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background-color: #000;
    }
    #globeViz {
      width: 100vw;
      height: 100vh;
      display: block;
    }
    #timeDisplay {
      position: absolute;
      top: 20px;
      left: 20px;
      color: white;
      font-family: sans-serif;
      background: rgba(0,0,0,0.7);
      padding: 10px;
      border-radius: 5px;
      z-index: 1000;
    }
  </style>
  
  <!-- Load Three.js first, then Globe.GL -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
  <script src="//unpkg.com/globe.gl"></script>
</head>
<body>
  <div id="globeViz"></div>
  <div id="timeDisplay">Current UTC: <span id="currentTime">--:--</span></div>

  <script>
    // Define texture URLs
    const DAY_TEXTURE = './earth-day.jpg';
    const NIGHT_TEXTURE = './earth-night.jpg';
    const FALLBACK_DAY_TEXTURE = '//unpkg.com/three-globe/example/img/earth-blue-marble.jpg';
    const FALLBACK_NIGHT_TEXTURE = '//unpkg.com/three-globe/example/img/earth-night.jpg';

    // Function to check if local images load
    function getGlobeImageUrls() {
        return new Promise(resolve => {
            const dayImg = new Image();
            const nightImg = new Image();
            let dayLoaded = false;
            let nightLoaded = false;

            function checkBothLoaded() {
                if (dayLoaded && nightLoaded) {
                    resolve({
                        day: dayImg.src,
                        night: nightImg.src
                    });
                }
            }

            dayImg.onload = () => {
                console.log(`✅ Day texture loaded: ${DAY_TEXTURE}`);
                dayLoaded = true;
                checkBothLoaded();
            };
            dayImg.onerror = () => {
                console.warn(`⚠️ Failed to load local day texture. Falling back to CDN.`);
                dayImg.src = FALLBACK_DAY_TEXTURE;
            };

            nightImg.onload = () => {
                console.log(`✅ Night texture loaded: ${NIGHT_TEXTURE}`);
                nightLoaded = true;
                checkBothLoaded();
            };
            nightImg.onerror = () => {
                console.warn(`⚠️ Failed to load local night texture. Falling back to CDN.`);
                nightImg.src = FALLBACK_NIGHT_TEXTURE;
            };

            dayImg.src = DAY_TEXTURE;
            nightImg.src = NIGHT_TEXTURE;
        });
    }

    // Calculate sun position based on current time
    function calculateSunPosition() {
        const now = new Date();
        const UTC_hours = now.getUTCHours();
        const UTC_minutes = now.getUTCMinutes();
        
        // Update time display
        document.getElementById('currentTime').textContent = 
            `${UTC_hours.toString().padStart(2, '0')}:${UTC_minutes.toString().padStart(2, '0')}`;
        
        // Calculate sun position (simplified)
        // The sun moves 15 degrees per hour (360°/24h)
        const hourAngle = (UTC_hours + UTC_minutes / 60) * Math.PI / 12;
        
        // Return sun position as [x, y, z] coordinates
        return [
            Math.cos(hourAngle),  // x
            0,                    // y (keep sun at equator level)
            Math.sin(hourAngle)   // z
        ];
    }

    // Update globe lighting based on time
    function updateDayNightCycle(globe) {
        const sunPosition = calculateSunPosition();
        
        // Simple point color update based on day/night
        const pointsData = globe.pointsData();
        if (pointsData && pointsData.length > 0) {
            const updatedPoints = pointsData.map(point => {
                // Convert lat/lng to 3D position
                // FIX: Changed point.lng to point.lon to match JSON data
                const latRad = point.lat * Math.PI / 180;
                const lngRad = point.lon * Math.PI / 180;
              
                const pointPos = [
                    Math.cos(lngRad) * Math.cos(latRad),
                    Math.sin(latRad),
                    Math.sin(lngRad) * Math.cos(latRad)
                ];
              
                // Dot product to determine if point is in sunlight
                const dotProduct = pointPos[0] * sunPosition[0] + 
                                 pointPos[1] * sunPosition[1] + 
                                 pointPos[2] * sunPosition[2];
              
                // Colors with 25% reduced brightness (multiplied by 0.75)
                return {
                    ...point,
                    color: dotProduct > 0 ? 
                        'rgba(191, 75, 75, 0.9)' :  // Day color - 25% darker red
                        'rgba(191, 191, 75, 0.9)'   // Night color - 25% darker yellow
                };
            });
            
            globe.pointsData(updatedPoints);
        }
    }

    // 1. Fetch the news data and initialize globe
    async function initializeGlobe() {
        const textureUrls = await getGlobeImageUrls();
        
        try {
            const response = await fetch('news_data.json');
            if (!response.ok) throw new Error('Failed to load news_data.json');
            const newsData = await response.json();

            // Initialize the Globe instance
            const myGlobe = new Globe(document.getElementById('globeViz'))
                .globeImageUrl(textureUrls.day)
                .backgroundImageUrl('//unpkg.com/three-globe/example/img/night-sky.png')
                
                .pointsData(newsData)
                // FIX: Explicitly tell Globe to use 'lon' for longitude
                .pointLng('lon')
                
                .pointAltitude(0.2)
                .pointRadius(0.5)
                .pointColor('color') // Use the dynamic color property we add
                .pointLabel(d => `
                    <div style="background: rgba(0,0,0,0.8); padding: 10px; color: white; border-radius: 5px; font-family: sans-serif;">
                        <b>${d.location}</b><br/>${d.title}
                    </div>
                `)
                .onPointClick(d => window.open(d.url, '_blank'));

            // Set initial auto-rotation
            myGlobe.controls().autoRotate = true;
            myGlobe.controls().autoRotateSpeed = 0.5;

            console.log(`Globe initialized with ${newsData.length} data points.`);

            // Start day-night cycle updates
            function updateCycle() {
                updateDayNightCycle(myGlobe);
            }

            // Update immediately and then every minute
            updateCycle();
            setInterval(updateCycle, 60000); // Update every minute

        } catch (error) {
            console.error("Error initializing the globe:", error);
            document.getElementById('globeViz').innerHTML = `
                <div style="color: white; padding: 20px; text-align: center; background: #333; margin: 20vh auto; width: 80%; font-family: sans-serif;">
                    <h1>Error Loading Globe Data</h1>
                    <p>Details: ${error.message}</p>
                </div>
            `;
        }
    }

    // Start the asynchronous process
    initializeGlobe();
  </script>
</body>
